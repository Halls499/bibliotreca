<?php
// ================= CONEXÃƒO =================
$host = "localhost";
$usuario = "root";
$senha = "";
$banco = "biblioteca";

$conexao = new mysqli($host, $usuario, $senha);
if ($conexao->connect_error) {
    die("Erro de conexÃ£o: " . $conexao->connect_error);
}

// ================= BANCO =================
$conexao->query("CREATE DATABASE IF NOT EXISTS $banco");
$conexao->select_db($banco);

// ================= TABELAS =================
$conexao->query("
CREATE TABLE IF NOT EXISTS autor (
    id_autor INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    nacionalidade VARCHAR(50)
)");

$conexao->query("
CREATE TABLE IF NOT EXISTS livro (
    id_livro INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(100) NOT NULL,
    ano_publicacao INT,
    id_autor INT,
    FOREIGN KEY (id_autor) REFERENCES autor(id_autor)
)");

$conexao->query("
CREATE TABLE IF NOT EXISTS pessoa (
    id_pessoa INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    telefone VARCHAR(20),
    email VARCHAR(100)
)");

$conexao->query("
CREATE TABLE IF NOT EXISTS emprestimo (
    id_emprestimo INT AUTO_INCREMENT PRIMARY KEY,
    id_livro INT NOT NULL,
    id_pessoa INT NOT NULL,
    data_emprestimo DATE NOT NULL,
    data_prevista_devolucao DATE,
    FOREIGN KEY (id_livro) REFERENCES livro(id_livro),
    FOREIGN KEY (id_pessoa) REFERENCES pessoa(id_pessoa)
)");

// ================= PROCESSAR FORMULÃRIOS =================
if ($_SERVER["REQUEST_METHOD"] === "POST") {

    if (isset($_POST["novo_autor"])) {
        $nome = $_POST["nome_autor"];
        $nac = $_POST["nacionalidade"];
        $conexao->query("INSERT INTO autor (nome, nacionalidade) VALUES ('$nome','$nac')");
    }

    if (isset($_POST["novo_livro"])) {
        $titulo = $_POST["titulo"];
        $ano = $_POST["ano_publicacao"];
        $autor = $_POST["id_autor"];
        $conexao->query("INSERT INTO livro (titulo, ano_publicacao, id_autor)
                         VALUES ('$titulo','$ano','$autor')");
    }

    if (isset($_POST["nova_pessoa"])) {
        $nome = $_POST["nome_pessoa"];
        $tel = $_POST["telefone"];
        $email = $_POST["email"];
        $conexao->query("INSERT INTO pessoa (nome, telefone, email)
                         VALUES ('$nome','$tel','$email')");
    }

    if (isset($_POST["novo_emprestimo"])) {
        $livro = $_POST["id_livro"];
        $pessoa = $_POST["id_pessoa"];
        $data = $_POST["data_emprestimo"];
        $prev = $_POST["data_prevista_devolucao"];
        $conexao->query("INSERT INTO emprestimo 
        (id_livro, id_pessoa, data_emprestimo, data_prevista_devolucao)
        VALUES ('$livro','$pessoa','$data','$prev')");
    }

    header("Location: biblioteca.php");
    exit;
}
?>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Biblioteca</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; margin: 20px; }
        h1 { text-align: center; }
        h2 { margin-top: 40px; }
        form, table { background: #fff; padding: 15px; margin-top: 10px; }
        input, select, button { padding: 6px; margin: 5px 0; width: 100%; max-width: 400px; }
        button { background: #007bff; color: #fff; border: none; cursor: pointer; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background: #eee; }
    </style>
</head>
<body>

<h1>ðŸ“š Sistema de Biblioteca</h1>

<h2>Adicionar Autor</h2>
<form method="post">
    <input type="hidden" name="novo_autor">
    <input type="text" name="nome_autor" placeholder="Nome" required>
    <input type="text" name="nacionalidade" placeholder="Nacionalidade">
    <button>Salvar</button>
</form>

<h2>Adicionar Livro</h2>
<form method="post">
    <input type="hidden" name="novo_livro">
    <input type="text" name="titulo" placeholder="TÃ­tulo" required>
    <input type="number" name="ano_publicacao" placeholder="Ano">

    <select name="id_autor" required>
        <option value="">Selecione o autor</option>
        <?php
        $res = $conexao->query("SELECT * FROM autor");
        while ($a = $res->fetch_assoc()) {
            echo "<option value='{$a['id_autor']}'>{$a['nome']}</option>";
        }
        ?>
    </select>
    <button>Salvar</button>
</form>

<h2>Adicionar Pessoa</h2>
<form method="post">
    <input type="hidden" name="nova_pessoa">
    <input type="text" name="nome_pessoa" placeholder="Nome" required>
    <input type="text" name="telefone" placeholder="Telefone">
    <input type="email" name="email" placeholder="Email">
    <button>Salvar</button>
</form>

<h2>Registrar EmprÃ©stimo</h2>
<form method="post">
    <input type="hidden" name="novo_emprestimo">

    <select name="id_livro" required>
        <option value="">Livro</option>
        <?php
        $res = $conexao->query("SELECT * FROM livro");
        while ($l = $res->fetch_assoc()) {
            echo "<option value='{$l['id_livro']}'>{$l['titulo']}</option>";
        }
        ?>
    </select>

    <select name="id_pessoa" required>
        <option value="">Pessoa</option>
        <?php
        $res = $conexao->query("SELECT * FROM pessoa");
        while ($p = $res->fetch_assoc()) {
            echo "<option value='{$p['id_pessoa']}'>{$p['nome']}</option>";
        }
        ?>
    </select>

    <input type="date" name="data_emprestimo" required>
    <input type="date" name="data_prevista_devolucao">
    <button>Salvar</button>
</form>

<h2>EmprÃ©stimos</h2>
<table>
<tr>
    <th>ID</th><th>Livro</th><th>Pessoa</th><th>Data</th><th>DevoluÃ§Ã£o</th>
</tr>
<?php
$res = $conexao->query("
SELECT e.id_emprestimo, l.titulo, p.nome, e.data_emprestimo, e.data_prevista_devolucao
FROM emprestimo e
JOIN livro l ON e.id_livro = l.id_livro
JOIN pessoa p ON e.id_pessoa = p.id_pessoa
");

while ($e = $res->fetch_assoc()) {
    echo "<tr>
        <td>{$e['id_emprestimo']}</td>
        <td>{$e['titulo']}</td>
        <td>{$e['nome']}</td>
        <td>{$e['data_emprestimo']}</td>
        <td>{$e['data_prevista_devolucao']}</td>
    </tr>";
}
?>
</table>

</body>
</html>
